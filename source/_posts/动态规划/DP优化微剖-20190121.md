---
title: 'DP 优化微剖'
categories: 
  - 动态规划
mathjax: true
abbrlink: 18425
date: 2019-01-21 09:24:32
updated: 2019-01-21 09:24:32
tags:
---

# 引言

学习朱晨光《从《鹰蛋》一题浅析对动态规划算法的优化》的笔记

<!--more-->

# 鹰蛋问题引入

有一堆共 M 个鹰蛋，一位教授想研究这些鹰蛋的坚硬度 E。

他是通过不断 从一幢 N 层的楼上向下扔鹰蛋来确定 E 的。当鹰蛋从第 E 层楼及以下楼层落下时是不会碎的，但从第（E+1）层楼及以上楼层向下落时会摔碎。

如果鹰蛋未摔 碎，还可以继续使用；但如果鹰蛋全碎了却仍未确定 E，这显然是一个失败的实验。教授希望实验是成功的。

例如：若鹰蛋从第 1 层楼落下即摔碎，E=0；若鹰蛋从第 N 层楼落下仍未碎， E=N。这里假设所有的鹰蛋都具有相同的坚硬度。

给定鹰蛋个数 M 与楼层数 N。 要求**最坏情况**下确定 E 所需要的最少次数。

## 样例输入

M=1,N=10

## 样例输出

ANS=10

## 样例解释

为了不使实验失败，只能将这个鹰蛋按照从一楼到十楼的顺序依次扔下。一旦在第（E+1）层楼摔碎，E 便确定了（假设在第（N+1）层摔鹰蛋会碎）。那么最坏情况就是在第 N 层仍未碎，则次数为 10，E=10.

# 初步 DP

乍一看题目比较玄学，我们就从玄学的 DP 开始想。题目中有两个维度：鹰蛋个数和楼的高度，那么我们想办法利用这两个维度。

定义 $f[i,j]$ 表示用 $i$ 个蛋，在高度为 $j$ 的楼实验的**最坏情况**下的最少次数。

考虑第 $i$ 个蛋分别在第 $1\sim j$ 层的实验情况，在第 $k$ 层实验：

1. 摔碎，说明 $E\leq k$，但仍没有确定 $E$，因此还需要用剩下的 $i-1$ 个蛋在 $1\sim k-1$ 层继续实验；
2. 未碎，说明 $E>k$，仍没有确定 $E$，还需要用 $i$ 个蛋在 $k+1\sim j$ 层，即层数为 $j-k$ 的楼，继续实验。

题目中所说的**最坏情况**，即要求上述两种情况取最大值。

最坏情况的最小次数，即对于所有 $k\in[1,j]$ 的最坏情况取最小值。

转移方程如下：
$$
\begin{split}
f[i,j]&=\min_{k=1}^j\left\{\max\left(f[i-1,k-1]+1,f[i,j-k]+1\right)\right\}\\
&=\min_{k=1}^j\left\{\max\left(f[i-1,k-1],f[i,j-k]\right)\right\}+1
\end{split}
$$

## 复杂度分析

显然鹰蛋的个数不超过楼层的高度，那么令 $M=N$，则复杂度为 $O(N^3)$，空间复杂度用滚存优化为 $O(n)$.

# 二分剪枝

其实大多数人看到这道题的第一个反应怕不是 DP 而是二分。正常思维来看，应该是在高度为 N 的楼上二分着丢蛋对吧。这时的最坏情况次数为 $log_2(n+1)$，并且是可以达到的下限。

因此，一旦 $M>log_2(n+1)$，就可以直接输出 $log_2(n+1)$；否则再进行上述 DP 过程。

时间复杂度降为 $N^2log_2N$，空间复杂度仍为 $O(N)$.

# 单调性分析

## 引理 1

$$
\forall i\in[1,M],j\in[1,N]\\
f[i,j]\geq f[i,j-1].
$$

### 证明

#### 当 $i=1$ 时

那么 $f[1,j]=j$（一个蛋要最坏扔 $j$ 次），显然 $f[1,j]\geq f[1,j-1]$ 成立。

#### 当 $i>1$ 时

$$
\begin{split}
f[i,0]=&0\\
f[i,1]=&\max\{f[i-1,0],f[i,0]\}+1=1\\
\end{split}
$$

即当 j=1 时，不等式成立

假设不等式对 $f[i,1\sim j-1]$ 都成立，那么
$$
\begin{split}
f[i,j]=&\min_{k=1}^j\left\{\max\left(f[i-1,k-1],f[i,j-k]\right)\right\}+1\\
f[i,j-1]=&\min_{k=1}^{j-1}\left\{\max\left(f[i-1,k-1],f[i,j-1-k]\right)\right\}+1\\
\end{split}
$$

根据假设有

$$
\begin{split}
&f[i,j-k]\geq f[i,j-1-k]\\
\Rightarrow& \max\left(f[i-1,k-1],f[i,j-k]\right) \geq \max\left(f[i-1,k-1],f[i,j-1-k]\right)\\
\Rightarrow& f[i,j] \geq f[i,j-1]\\
&&\square
\end{split}.
$$

## 二分查找最优决策

有了上述单调性引理，那么观察一下 DP 方程：

- $f[i-1,k-1]$ 是关于 $k$ 非严格单调递增的；
- $f[i,j-1-k]$ 是关于 $k$ 非严格单调递减的。

那么取他们的**最大值的最小值**显然就是当两个值最接近的时候啦

所以状态转移的时候二分一下就可以啦

## 复杂度分析

状态转移复杂度从 $O(n)$ 降到 $O(log_2n)$，整体时间复杂度为 $O(Nlog_2^2N)$，空间复杂度仍然为滚存，$O(N)$.

# 挖掘转移方程

## 引理 2

$$
\forall i\in[1,M],j\in[1,N]\\
f[i,j]\leq f[i,j-1]+1.
$$

### 证明

$$
\begin{split}
&f[i,j]=\min_{k=1}^j\left\{\max\left(f[i-1,k-1],f[i,j-k]\right)\right\}+1\\
\Rightarrow &f[i,j]\leq \max_{k=1}^j\left(f[i-1,k-1],f[i,j-k]\right)+1\\
\Rightarrow &f[i,j]\leq \max\left(f[i-1,0],f[i,j-1]\right)+1\\
\Rightarrow &f[i,j]\leq f[i,j-1]+1\\
&&\square
\end{split}
$$

## 推论

根据**引理 1**，有 $f[i,j-1]\leq f[i,j]\leq f[i,j-1]+1$.

即 $f[i]$ 的状态空间是离散，线性，非严格单调，连续的。

## 转移策略

根据上述推论，可以想到以下的转移策略：

- 如果存在 $k$ 使得 $max(f[i-1,k-1],f[i,j-k])+1=f[i,j-1]$，那么就让 $f[i,j]\leftarrow f[i,j-1]$.
- 否则，即不存在上述 $k$，那么令 $f[i,j]\leftarrow f[i,j-1]+1$.

因此我们维护一个指针 $p$ 满足：

- $f[i,p]<f[i,j-1]$.
- $f[i,p+1]=f[i,j-1]$.

那么显然有以下推论：

- $f[i,p]=f[i,j-1]-1$.
- $\forall x\in[p+1,j-1],f[i,x]=f[i,j-1]$.

## 挖掘方程

对于 DP 方程
$$
f[i,j]=\min_{k=1}^j\left\{\max\left(f[i-1,k-1],f[i,j-k]\right)\right\}+1
$$
对于上述方程中状态空间 $f[i]$，显然我们可以找到一个对应的指针 $p$.

令 $k=j-p\in[1,j]$

显然 $(0\leq p\leq j-1)$.
$$
\begin{split}
f[i,j][leftarrow&\max\left(f[i-1,k-1],f[i,j-k]\right)+1\\
\leftarrow&\max\left(f[i-1,j-p-1],f[i,p]\right)+1\\
\leftarrow&\max\left\{\begin{split}
&f[i,p]+1=f[i,j-1]-1+1=f[i,j-1]\\
&f[i-1,j-p-1]
\end{split}\right.
\end{split}
$$

### Case1

当 $f[i-1,j-p-1]\leq f[i,p]$.

那么 $f[i,j][leftarrow f[i,p]+1=f[i,j-1]-1+1=f[i,j-1]$.

根据转移策略可知，此时 $f[i,j]=f[i,j-1]$.

### Case2

当 $f[i-1,j-p-1]>f[i,p]$.

此时我们考虑 $p'\in[1,j]$ 的各个决策的可行性

#### 当 $p'<p$ 时

那么根据引理 1
$$
\begin{split}
&p'<p,j-p'-1>j-p-1\\
\Rightarrow& f[i-1,j-p'-1]\geq f[i-1,j-p-1]>f[i,p]\geq f[i,p']\\
\Rightarrow& f[i-1,j-p'-1]> f[i,p']\\
\Rightarrow& max(f[i-1,j-p'-1],f[i,p'])=f[i-1,j-p'-1]>f[i,p]=f[i,j-1]-1\\
\Rightarrow& max(f[i-1,j-p'-1],f[i,p'])+1>f[i,j-1]
\end{split}
$$
因此 $p'$ 的决策**无法**使得 $f[i,j]=f[i,j-1]$.

#### 当 $p'=p$ 时

$$
\begin{split}
&p'=p,j-p'-1=j-p-1\\
\Rightarrow& f[i-1,j-p'-1]= f[i-1,j-p-1]>f[i,p]= f[i,p']\\
\Rightarrow& f[i-1,j-p'-1]> f[i,p']\\
\Rightarrow& max(f[i-1,j-p'-1],f[i,p'])=f[i-1,j-p'-1]>f[i,p]=f[i,j-1]-1\\
\Rightarrow& max(f[i-1,j-p'-1],f[i,p'])+1>f[i,j-1]
\end{split}
$$

只是把 $\geq$ 变成了 $=$，而 $>$ 的部分没有改变，同样**无法**使得 $f[i,j]=f[i,j-1]$.

#### 当 $p'>p$ 时

根据 $p$ 指针的定义以及定义域
$$
\begin{split}
&p'>p\Leftrightarrow p'\geq p+1\\
\Rightarrow &f[i,p]<f[i,p']=f[i,j-1]\\
\Rightarrow &f[i,p]<f[i,j-1]
\end{split}
$$
显然**无法**使得 $f[i,j]=f[i,j-1]$.



综上所述，在 $f[i-1,j-p-1]>f[i,p]$ 的情况下无法使得 $f[i,j]=f[i,j-1]$.

因此根据转移策略，$f[i,j]=f[i,j-1]+1$.

## 算法设计与复杂度分析

综上所述，我们只需要对每一个 $f[i,j]$ 找到对应的指针 $p$，然后考虑决策 $p$ 的大小情况，即可实现 $O(1)$ 的转移。

那么如何找到决策 $p$ 呢？显然我们只需要在遍历第二维的时候顺便 $O(1)$ 维护一下即可

转移的复杂度从 $O(log_2n)$ 降为 $O(n)$，整体时间复杂度 $O(Nlog_2N)$，空间上仍采用滚动数组，复杂度为 $O(N)$.

# 优化小结

回顾一下所讲到的四个部分：

1. 首先根据问题列出状态并设计了 DP 方程
2. 根据问题上界的分析简化算法，减小了算法上界复杂度
3. 分析转移方程蕴含的单调性，采用二分转移的方式，减少转移复杂度
4. 深入方程的数学本质，挖掘状态转移的有界性和可行性，只选择有效且可行的状态转移子空间，减少转移复杂度

# 全新的角度

上述动态规划的算法复杂度在数次优化后为 $O(Nlog_2N)$，现在我们从另一个角度审视问题

考虑 $g[i,j]$ 表示用 $j$ 个蛋尝试 $i$ 次在**最坏情况**下能确定 E 的**最高**楼层数

- $g[1,j]=1$.（无论有多少个鹰蛋，只试一次，还要求确定 E，就只能确定第一层楼）
- $g[i,1]=i$.（只有一个鹰蛋，试 $i$ 次，要确定 E，最坏就是把 $1\sim i$ 层楼试完，则楼层数为 $i$）

状态转移则较为简单。因为要最大化楼层数，就无法确定丢蛋的具体位置，那么分两种情况

- 如果在某一层丢下去碎了，就要用余下的 $j-1$ 个蛋试 $i-1$ 次确定楼层的高度。既然我们希望楼层越高越好，这就是一个子问题，即为 $g[i-1,j-1]$.
- 如果没摔碎，就用余下的 $j$ 个蛋试 $i-1$ 次在上面的楼层确定高度。仍然是一个子问题，即为 $g[i-1,j]$.

因此转移方程为 $g[i,j]=g[i-1,j-1]+g[i-1,j]+1$.

目标：$x|g[x-1,M]<N,g[x,M]\geq N$.

## 复杂度初步分析

用上二分剪枝，时间复杂度 $O(Nlog_2N)$，空间上使用滚存，复杂度为 $O(N)$.

但其实这并不是严格的复杂度，下面给出严格复杂度上限的推导

## $g$ 与组合数

容易发现，$g[i,j]$ 与组合数函数 $C_i^j$ 极其相似：

| $g[i,j]$                       | $C_i^j$                                              |
| ------------------------------ | ---------------------------------------------------- |
| $g[1,j]=1$                     | $C_1^1=1\\C_1^j=0$                                   |
| $g[i,1]=i$                     | $C_i^1=i$                                            |
| $g[i,j]=g[i-1,j-1]+g[i-1,j]+1$ | $C_i^j=C_{i-1}^{j-1}+C_{i-1}^j,j\leq i\\C_i^j=0,j>i$ |

易证，$\forall i>0,j>0,\exists C_i^j\leq g(i,j)$.

## 放缩法

当 $x\leq M$ 的时候，有 $xM\leq M^2\leq log_2^2N<N$.

当 $x>M$ 时，根据 $x$ 的定义有
$$
\begin{split}
&C_{x-1}^M\leq g(x-1,M)<N
\Rightarrow C_{x-1}^M<N\\
\Rightarrow& \frac{\prod_{i=1}^M(x-i)}{M!}<N
\Rightarrow \prod_{i=1}^M(x-i)<NM!\\
\Rightarrow&(x-M)^M\leq \prod_{i=1}^M(x-i)<NM!
\Rightarrow(x-M)^M<NM!\\
\Rightarrow& x-M<\sqrt[M]{NM!}\leq \sqrt[M]{NM^M}=M\sqrt[M]{N}\\
\Rightarrow& x<M+M\sqrt[M]{N}=M(1+\sqrt[M]{N})\\
\Rightarrow& xM<M^2(1+\sqrt[M]{N})
\end{split}
$$
接下来考虑一下 $M^2(1+\sqrt[M]{N})$ 的上界。

## 引理 3

当 $1\leq N\leq 3$ 或 $N\geq 17$ 时，$log_2^2N<N$.

由函数图像即可知。

![p1](https://hexo-source-1257756441.cos.ap-chengdu.myqcloud.com/2019/01/21/1526.png)





根据**引理 3**，有 $N^{\frac{M-1}{M}}\approx N >log_2^2N\geq M^2$.

又 $\log_2N^{\frac{1}{M}}\approx \log_2(N^{\frac{1}{M}}+1)$
$$
\begin{split}
&N^{\frac{M-1}{M}}\geq M^2\\
\Rightarrow& \log_2N^{\frac{M-1}{M}}\geq \log_2M^2\\
\Rightarrow& \frac{M-1}{M}\log_2N\geq \log_2M^2\\
\Rightarrow& \log_2N-\frac{1}{M}\log_2N\geq \log_2M^2\\
\Rightarrow& \log_2N^{\frac{1}{M}}+\log_2M^2\leq \log_2N\\
\Rightarrow& \log_2N^{\frac{1}{M}}+\log_2M^2\leq \log_2N\\
\Rightarrow& \log_2(N^{\frac{1}{M}}+1)+\log_2M^2\leq \log_2N\\
\Rightarrow& \log_2M^2(N^{\frac{1}{M}}+1)\leq \log_2N\\
\Rightarrow& M^2(N^{\frac{1}{M}}+1)\leq N\\
\end{split}
$$
即，$xM<M^2(N^{\frac{1}{M}}+1)\leq N$.

综上所述，$xM\leq N$.

这说明 $g[i,j]$ 的实际计算量是 $O(N)$ 级别的。不过这也是一个大概的上界

## 感性图像解读

貌似论文的后面不那么严谨了，直接上图。

画出 $f(x)=\sqrt{x},g(x)=\left(x^{\frac{1}{\log_2x}}+1\right)\log_2^2x,h(x)=\frac{f(x)}{g(x)}$ 的图像：

其中蓝色为 $f(x)$，红色为 $g(x)$，绿色为 $h(x)$.

![p3](https://hexo-source-1257756441.cos.ap-chengdu.myqcloud.com/2019/01/21/1611.png)

于是我们可以大致感性证明，$f(x)$ 和 $g(x)$ 同阶

那么也就是说，$M^2(N^{\frac{1}{M}}+1)$ 是与 $\sqrt{N}$ 同阶的，因此实际时间复杂度为 $O(\sqrt{N})$.

# 总结

文章讲述了两种思考角度不同的 DP，对其中一种主以优化讲解，另一种主以复杂度分析讲解，十分有意思

# 参考文献

[1] 朱晨光。从《鹰蛋》一题浅析对动态规划算法的优化。IOI2004 国家集训队论文
