---
title: 扩展埃氏筛
mathjax: true
categories:
  - 数学
abbrlink: 48708
date: 2019-07-13 18:48:25
updated: 2019-07-13 18:48:25
tags:
keywords:
---

**摘要**

本文介绍一种比欧拉筛更高效的筛法，扩展 Eratosthenes 筛法。

<!--more-->

杜教筛适用范围较小，未充分利用积性。扩展埃氏筛要求对于任意质数 p，$f(p)$ 是一个关于 p 的**低阶多项式**。对于任意 $p^c\le n$ 的指数 $c$，$f(p^c)$ 可以快速求出。

# 约定

接下来先说明一下本文所用到的记号以及一些约定。

1. $F(n)=\sum_{i=1}^nf(i)$，即前缀和函数。
2. 从小到大第 i 个质数记作 $p_i$，特别地，$p_0=1$。
3. $\sqrt{n}$ 以内的质数有 m 个。
4. 对于集合 $S=\left\{x|y\in [1,n],x=\left\lfloor\frac{n}{y}\right\rfloor\right\}$，则 $|S|=O(\sqrt{n})$。
5. $\forall a,b,c\in N,\lfloor\frac{\left\lfloor\frac{a}{b}\right\rfloor}{c}\rfloor=\left\lfloor\frac{a}{bc}\right\rfloor$。

# 问题转化

我们要求的式子是
$$
F(n)=\sum_{i=1}^nf(i)
$$
其中 $f$ 是一个积性函数。首先我们知道 n 以内的数至多只有一个大于 $\sqrt{n}$ 的质因子，因此我们把数按照有无大于 $\sqrt{n}$ 的质因子分类考虑。对于含有大于 $\sqrt{n}$ 的一类，我们可以把这个质因子拎出来，剩下的就又是不含有大于 $\sqrt{n}$ 的一类。于是写出来就是这样的
$$
F(n)=\left(\sum_{i\text{ 无大于 }\sqrt{n}\text{ 的因子}}f(i) \right)
+\left(\sum_{i\text{ 无大于 }\sqrt{n}\text{ 的因子}}\left(f(i) \sum_{\sqrt{n}< p\le\left\lfloor\frac{n}{i}\right\rfloor,\ p\text{ is prime}}f(p) \right)\right)
$$

注意到后半部分内层求和因子的条件，由于 $\sqrt{n}< \left\lfloor\frac{n}{i}\right\rfloor$，因此 $i< \sqrt{n}$，于是得到
$$
F(n)=\left(\sum_{i\text{ 无大于 }\sqrt{n}\text{ 的因子}}f(i) \right)
+\left(\sum_{i=1}^{\sqrt{n}}\left(f(i) \sum_{\sqrt{n}< p\le\left\lfloor\frac{n}{i}\right\rfloor,\ p\text{ is prime}}f(p) \right)\right)\tag{1}
$$
问题转化为处理式子的前半部分和后半部分。

# 后半部分

我们考虑 $(1)$ 的后半部分
$$
\sum_{i=1}^{\sqrt{n}}\left(f(i) \sum_{\sqrt{n}< p\le\left\lfloor\frac{n}{i}\right\rfloor,\ p\text{ is prime}}f(p)\right) \tag{2}
$$


先考虑这样一个问题，求
$$
\sum_{\sqrt{n}< p\le\left\lfloor\frac{n}{i}\right\rfloor,\ p\text{ is prime}}f(p)
$$
由于 $f(p)$ 是一个多项式，因此我们可以对每一项分别做，问题转化为求
$$
\sum_{\sqrt{n}< p\le\left\lfloor\frac{n}{i}\right\rfloor,\ p\text{ is prime}}p^k \tag{3}
$$
我们考虑 DP。设 $dp[i,j]$ 表示对于满足 $x\le j$ 且 $x$ 与 $p_0\cdot p_1\cdots p_i$ 的最大公约数为 1 的 $x^k$ 的和。即
$$
dp[i,j]=\sum_{x\le j,\gcd(x,\prod_{k=0}^ip_k)=1}x^k
$$
注意在上式中，一定满足 $x>p_i\vee x=1$，否则无法互质。

先考虑 $dp[0,j]=\sum_{x=1}^jx^k$，这个可以用拉格朗日插值在 $O(k)$ 的时间内计算出来。另一个显然的边界是 $dp[i,0]=0$。

然后考虑转移。从 $dp[i-1,j]$ 转移到 $dp[i,j]$，我们希望 $p_i$ 与 $x$ 互质。显然这并不容易枚举，因此我们枚举不与 $p_i$ 互质的部分，得到
$$
dp[i,j]=dp[i-1,j]-{p_i}^kdp\left[i-1,\left\lfloor\frac{j}{p_i}\right\rfloor\right]
$$
变成然后再回到 $(3)$，你发现与 $p_1p_2\dots p_m$ 互质的 $n$ 以内的数一定是质数，于是得到
$$
dp\left[m,\left\lfloor\frac{n}{i}\right\rfloor\right]=\sum_{\sqrt{n}< p\le\left\lfloor\frac{n}{i}\right\rfloor,\ p\text{ is prime}}p^k
$$
那最终我们要求哪些 DP 值？由于 $1\le i\le \sqrt{n}$，于是 $\left\lfloor\frac{n}{i}\right\rfloor$ 不超过 $\sqrt{n}$ 种，可以递归做。这样做的复杂度是 $O\left(\frac{n}{\log_2n}\right)$。因为质数密度是 $O\left(\frac{1}{\log_2n}\right)$，而计算 DP 值时我们只枚举 $\sqrt{n}$ 以内的质数（这部分质数直接先欧拉筛预处理）。

#  优化

上述 DP 方程仍可以优化。上文中我们分析过，对于满足 $x\le j,\gcd(x,\prod_{k=0}^ip_k)=1$ 的 $x$ 必须满足 $x>p_i\vee x=1$。事实上，如果 $\gcd(x,\prod_{k=0}^ip_k)=1$，说明 $x$ 不可能满足 $p_{i}<x<p_{i+1}$，显然在这个区间的合数都不合法。这样可以得到：

1. 当 $j<p_i$ 时，$dp[i,j]=0$，前文所述。
2. 当 $p_i\le j<p_{i+1}$ 时，$dp[i,j]=1$，因为这时候只有 $x=1$ 满足条件。
3. 当 $p_i\le j<{p_i}^2$ 时，有 $\left\lfloor\frac{j}{p_i}\right\rfloor<p_i$，则转移变成 $dp[i,j]=dp[i-1,j]-{p_i}^k$。因为 $dp\left[i-1,\left\lfloor\frac{j}{p_i}\right\rfloor\right]=1$。

思考这样一个过程：我们要计算 $dp[i,j],\ p_i\le j$。于是我们从小到大枚举一个 $x$ 。

当 ${p_x}^2\le j$ 时我们按照普通的 DP 方程直接转移计算 $dp[x,j]$；

当 $j< {p_x}^2$ 时，显然之后的所有的 $x$ 都满足 $p_x\le p_i\le j<{p_x}^2$，于是可以直接累加 ${p_x}^k$。因此我们记 $d_j=x\mid {p_x}^2\le j<{p_{x+1}}^2$ ，表示 $j$ 的转移的最后一个位置。于是得到
$$
dp[i,j]=dp[d_j,j]-\sum_{x=d_j+1}^i{p_x}^k
$$
后半部分显然可以预处理前缀和。这样优化后，算法复杂度降低到 $O\left(\frac{n^{\frac{3}{4}}}{\log_2n}\right)$。

# Min_25 筛

考虑另一种转化
$$
F(n)=1+\sum_{2\le p^e\le n,e\ge 1,\ p\text{ is a prime}}f(p^e)\left(1+\sum_{2\le x\le \left\lfloor\frac{n}{p^e}\right\rfloor,\ x\text{ 无 }\le p\text{ 的质因子}}f(x)\right)
$$

我们仍按照质因子与$\sqrt{n}$的大小关系分类：
$$
F(n)=1+\sum_{
2\le p\le \sqrt{n},2\le p^e\le n,\\ e\ge 1,\ p\text{ is a prime}
}f(p^e)\left(1+\sum_{2\le x\le \left\lfloor\frac{n}{p^e}\right\rfloor,\ x\text{ 无 }\le p\text{ 的因子}}f(x)\right)+\sum_{\sqrt{n}<p\le n,\ p\text{ is a prime}}f(p)
$$
接下来我们考虑DP。设
$$
g[i,j]=\sum_{2\le x\le i,\ x\text{ 无 }\le j\text{ 的质因子}}f(x)\\
h[i]=\sum_{2\le p\le i,\ p\text{ is a prime}}f(p)
$$
对于$g$函数，当$j>\sqrt{i}$时，显然$g[i,j]=h[i]-h[j]$。

否则$j\le \sqrt{i}$，考虑DP的转移
$$
\begin{split}
g[i,j]&=\sum_{2\le x\le i,\ x\text{ 无 }\le j\text{ 的质因子}}f(x)\\
&=\sum_{j<p\le \sqrt{i},\ p^e\le i,\\e\ge 1,p\text{ is a prime}}f(p^e)\left(1+\sum_{2\le x\le \left\lfloor\frac{i}{p^e}\right\rfloor,\ x\text{ 无 }\le p\text{ 的质因子}}f(x)\right)+\sum_{\sqrt{i}<p\le i,\ p\text{ is a prime}}f(p)\\
&=\sum_{j<p\le \sqrt{i},\ p^e\le i,\\e\ge 1,p\text{ is a prime}}f(p^e)\left(1+g\left[\left\lfloor\frac{i}{p^e}\right\rfloor,p\right]\right)+h[i]-h[\sqrt{i}]\\
\end{split}
$$
答案即为$g[n,0]+f(1)$。